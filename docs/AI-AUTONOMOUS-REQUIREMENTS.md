# MwManger Agent 리팩토링 - AI 자율 수행용 요구사항 정의서

> **목적**: AI가 사람과의 상호작용 없이 자율적으로 프로젝트를 수행할 수 있도록 작성된 요구사항 정의서

---

## 1. 프로젝트 개요

| 항목 | 내용 |
|------|------|
| **프로젝트명** | MwManger Agent 리팩토링 |
| **대상** | Java 1.8 기반 원격 서버 관리 에이전트 (데몬 프로세스) |
| **목표** | 보안 강화 + 아키텍처 개선 + 테스트 커버리지 확보 |
| **산출물** | 리팩토링된 소스코드, 테스트 코드, 테스트 서버, 기술 문서 |

---

## 2. 비즈니스 목표

1. **보안 강화**: 운영 환경에서 발생할 수 있는 보안 위협 차단
2. **인증 체계 현대화**: 토큰 탈취에 대비한 인증서 기반 상호 인증 도입
3. **유지보수성 향상**: 테스트 가능한 구조로 전환
4. **AI 협업 최적화**: 향후 AI 기반 개발이 용이한 구조 확립

---

## 3. 기능 요구사항

### FR-1: 인증 체계 이원화

| ID | 요구사항 |
|----|----------|
| FR-1.1 | mTLS(상호 인증서) 기반 인증을 지원해야 한다 |
| FR-1.2 | 기존 Refresh Token 기반 인증도 계속 지원해야 한다 (하위 호환) |
| FR-1.3 | 두 인증 방식은 설정(`use_mtls`)으로 전환 가능해야 한다 |
| FR-1.4 | OAuth2 표준 토큰 엔드포인트(`/oauth2/token`)를 사용해야 한다 |
| FR-1.5 | Access Token 만료 시 자동 갱신되어야 한다 |
| FR-1.6 | Refresh Token 만료 시 mTLS로 자동 fallback 되어야 한다 |

### FR-2: 생명주기 관리

| ID | 요구사항 |
|----|----------|
| FR-2.1 | 에이전트는 명확한 상태(생성/시작/실행/종료/실패)를 가져야 한다 |
| FR-2.2 | 종료 시 실행 중인 작업이 완료될 때까지 대기해야 한다 (Graceful Shutdown) |
| FR-2.3 | 종료 대기 시간은 최대 30초로 제한한다 |
| FR-2.4 | 종료 전 로그가 파일에 flush 되어야 한다 |

### FR-3: 서비스 분리

| ID | 요구사항 |
|----|----------|
| FR-3.1 | Kafka 관련 기능은 하나의 서비스로 통합 관리되어야 한다 |
| FR-3.2 | 명령 실행은 ThreadPool 기반 서비스로 관리되어야 한다 |
| FR-3.3 | 에이전트 등록 프로세스는 독립된 서비스로 분리되어야 한다 |
| FR-3.4 | 각 서비스는 독립적으로 시작/종료가 가능해야 한다 |

### FR-4: 테스트 환경

| ID | 요구사항 |
|----|----------|
| FR-4.1 | mTLS 테스트를 위한 인증서 생성 스크립트를 제공해야 한다 |
| FR-4.2 | OAuth2 토큰 발급을 테스트할 수 있는 Mock 서버를 제공해야 한다 |
| FR-4.3 | JWT 토큰 검증 예제 서비스를 제공해야 한다 |
| FR-4.4 | 인증서 발급 프로세스를 시뮬레이션할 CA 서버를 제공해야 한다 |

---

## 4. 비기능 요구사항

### NFR-1: 보안

| ID | 요구사항 | 우선순위 |
|----|----------|----------|
| NFR-1.1 | Command Injection 공격을 방어해야 한다 | CRITICAL |
| NFR-1.2 | Path Traversal 공격을 방어해야 한다 | CRITICAL |
| NFR-1.3 | 토큰은 로그에 마스킹되어 출력되어야 한다 | HIGH |
| NFR-1.4 | 보안 검증은 설정으로 on/off 가능해야 한다 | MEDIUM |
| NFR-1.5 | 인증서 복사 공격 방지를 위해 IP 검증이 가능해야 한다 | MEDIUM |

### NFR-2: 호환성

| ID | 요구사항 |
|----|----------|
| NFR-2.1 | JDK 1.8에서 동작해야 한다 |
| NFR-2.2 | Windows, Linux, AIX, HP-UX에서 동작해야 한다 |
| NFR-2.3 | 기존 API 시그니처는 유지되어야 한다 |
| NFR-2.4 | 기존 설정 파일 형식과 호환되어야 한다 |

### NFR-3: 테스트

| ID | 요구사항 |
|----|----------|
| NFR-3.1 | 단위 테스트 200개 이상을 작성해야 한다 |
| NFR-3.2 | 모든 테스트는 100% 통과해야 한다 |
| NFR-3.3 | 통합 테스트는 환경변수로 조건부 실행 가능해야 한다 |
| NFR-3.4 | 테스트 프레임워크는 JUnit 5를 사용해야 한다 |

### NFR-4: 아키텍처

| ID | 요구사항 |
|----|----------|
| NFR-4.1 | 의존성 주입(DI)을 통해 테스트 가능한 구조여야 한다 |
| NFR-4.2 | 주요 컴포넌트는 인터페이스로 추상화되어야 한다 |
| NFR-4.3 | 설정, HTTP 클라이언트는 Mock으로 대체 가능해야 한다 |
| NFR-4.4 | 버전은 단일 소스에서 관리되어야 한다 |

---

## 5. 제약 조건

### 5.1 기술 제약

| 제약 | 사유 |
|------|------|
| Gradle 사용 금지 | 프록시/SSL 환경에서 동작하지 않음 |
| Maven 3.9.6 사용 | `tools/` 디렉토리에 포함된 버전 사용 |
| 프록시: `http://70.10.15.10:8080` | 빌드 시 환경변수로 설정 필요 |
| System.err 출력 금지 | 데몬 프로세스이므로 파일 로그만 사용 |

### 5.2 삭제 금지 파일

- `pom.xml`
- `tools/apache-maven-3.9.6/`
- `build-offline.bat`, `build-offline.sh`

### 5.3 하위 호환성

- 기존 `PreWork`, `FirstWork`, `MainWork` 클래스명 유지
- 기존 `agent.properties` 설정 키 유지
- 기존 API 엔드포인트 계속 지원 (`/api/v1/security/refresh`)

---

## 6. 설계 원칙

| 원칙 | 적용 방법 |
|------|----------|
| **Test-Driven** | 기능 구현 전 테스트 코드 먼저 작성 |
| **SOLID** | 단일 책임, 인터페이스 분리, 의존성 역전 적용 |
| **Phase 분할** | 독립적으로 완료/검증 가능한 단위로 작업 분할 |
| **문서화** | AI가 컨텍스트를 빠르게 파악할 수 있는 CLAUDE.md 작성 |

---

## 7. 산출물 정의

### 7.1 소스코드

| 영역 | 설명 |
|------|------|
| 생명주기 관리 | 상태 관리, Graceful Shutdown |
| 서비스 레이어 | Kafka, 명령실행, 등록 서비스 |
| 보안 검증 | Command Injection, Path Traversal 방어 |
| DI 인프라 | 인터페이스, 어댑터, DI 컨테이너 |
| mTLS 지원 | 인증서 기반 HTTP 클라이언트 |

### 7.2 테스트 코드

| 유형 | 대상 |
|------|------|
| 단위 테스트 | 모든 신규 클래스 |
| 통합 테스트 | mTLS 인증 흐름, 토큰 갱신 흐름 |
| 보안 테스트 | 취약점 방어 검증 |

### 7.3 테스트 서버 (Python)

| 서버 | 용도 |
|------|------|
| Mock Auth Server | OAuth2 토큰 발급, mTLS 검증 |
| Biz Service | JWT 토큰 검증 예제 |
| CA Server | 인증서 발급/갱신 시뮬레이션 |

### 7.4 문서

| 문서 | 내용 |
|------|------|
| CLAUDE.md | AI를 위한 프로젝트 핵심 규칙 |
| 인증 흐름 문서 | mTLS + JWT 흐름 (Mermaid 다이어그램) |
| 프로젝트 보고서 | 목적, 수행내용, 시사점 (Mermaid 다이어그램) |

---

## 8. 성공 기준

| 기준 | 측정 방법 |
|------|----------|
| 테스트 통과 | `mvn test` 실행 시 200개 이상 테스트 100% 통과 |
| 빌드 성공 | `build-offline.bat` 실행 시 `build/mwmanger.jar` 생성 |
| mTLS 동작 | Mock 서버와 mTLS 통신 성공 |
| Legacy 동작 | 기존 방식 인증 성공 |
| 보안 검증 | SecurityValidator 테스트 통과 |

---

## 9. 작업 순서 (권장)

```
1. 생명주기 관리 프레임워크 구현
2. 서비스 레이어 분리
3. 보안 검증 모듈 구현
4. DI 아키텍처 구현
5. mTLS 지원 추가
6. 테스트 서버 구현
7. 통합 테스트 작성
8. 코드 품질 개선
9. 문서 작성
```

각 단계 완료 시 테스트 실행하여 회귀 버그 확인

---

## 10. 의사결정 가이드

AI가 판단해야 할 상황에서의 기준:

| 상황 | 결정 기준 |
|------|----------|
| 클래스/메서드 명명 | 기존 코드 스타일 따름, 명확한 의도 표현 |
| 패키지 구조 | 기능별 분리 (lifecycle, service, infrastructure) |
| 예외 처리 | 로그 남기고 상위로 전파, 데몬이므로 강제 종료 지양 |
| 테스트 범위 | public 메서드 위주, 경계값/예외 케이스 포함 |
| 인터페이스 추출 | 외부 의존성(HTTP, 설정)은 인터페이스로 추상화 |
| 설정 기본값 | 보안 관련은 안전한 쪽(ON), 기능 제한은 느슨한 쪽(OFF) |

---

**문서 버전**: 1.0
**작성일**: 2025-12-18
