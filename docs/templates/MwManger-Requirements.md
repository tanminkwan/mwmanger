# MwManger Agent 리팩토링 - 요구사항

> **사용 방법**: 이 문서와 `AI-AUTONOMOUS-GUIDELINES.md`를 함께 AI에게 제공합니다.

---

## 1. 프로젝트 개요

| 항목 | 내용 |
|------|------|
| **프로젝트명** | MwManger Agent 리팩토링 |
| **대상** | 기존 MwManger Agent 소스코드 |
| **목표** | 보안 강화 + 아키텍처 개선 + 테스트 커버리지 확보 |
| **산출물** | 리팩토링된 소스코드, 테스트 코드, 기술 문서 |

---

## 2. 비즈니스 목표

1. **보안 강화**: 운영 환경에서 발생할 수 있는 보안 위협 차단
2. **인증 체계 현대화**: 토큰 탈취에 대비한 인증서 기반 상호 인증 도입
3. **유지보수성 향상**: 테스트 가능한 구조로 전환
4. **AI 협업 최적화**: 향후 AI 기반 개발이 용이한 구조 확립

---

## 3. 기능 요구사항

### FR-1: 인증 체계 이원화

| ID | 요구사항 |
|----|----------|
| FR-1.1 | mTLS(상호 인증서) 기반 인증을 지원해야 한다 |
| FR-1.2 | 기존 Refresh Token 기반 인증도 계속 지원해야 한다 (하위 호환) |
| FR-1.3 | 두 인증 방식은 설정(`use_mtls`)으로 전환 가능해야 한다 |
| FR-1.4 | OAuth2 표준 토큰 엔드포인트(`/oauth2/token`)를 사용해야 한다 |
| FR-1.5 | Access Token 만료 시 자동 갱신되어야 한다 |
| FR-1.6 | Refresh Token 만료 시 mTLS로 자동 fallback 되어야 한다 |

### FR-2: 생명주기 관리

| ID | 요구사항 |
|----|----------|
| FR-2.1 | 에이전트는 명확한 상태(생성/시작/실행/종료/실패)를 가져야 한다 |
| FR-2.2 | 종료 시 실행 중인 작업이 완료될 때까지 대기해야 한다 (Graceful Shutdown) |
| FR-2.3 | 종료 대기 시간은 최대 30초로 제한한다 |
| FR-2.4 | 종료 전 로그가 파일에 flush 되어야 한다 |

### FR-3: 서비스 분리

| ID | 요구사항 |
|----|----------|
| FR-3.1 | Kafka 관련 기능은 하나의 서비스로 통합 관리되어야 한다 |
| FR-3.2 | 명령 실행은 ThreadPool 기반 서비스로 관리되어야 한다 |
| FR-3.3 | 에이전트 등록 프로세스는 독립된 서비스로 분리되어야 한다 |
| FR-3.4 | 각 서비스는 독립적으로 시작/종료가 가능해야 한다 |

### FR-4: 테스트 서버 구현

| ID | 요구사항 |
|----|----------|
| FR-4.1 | mTLS 테스트를 위한 인증서 생성 스크립트를 제공해야 한다 |
| FR-4.2 | OAuth2 토큰 발급을 테스트할 수 있는 Mock Auth Server를 구현해야 한다 |
| FR-4.3 | JWT 토큰 검증 예제 Biz Service를 구현해야 한다 |
| FR-4.4 | 인증서 발급 프로세스를 시뮬레이션할 CA Server를 구현해야 한다 |

---

## 4. 비기능 요구사항

### NFR-1: 보안

| ID | 요구사항 | 우선순위 |
|----|----------|----------|
| NFR-1.1 | Command Injection 공격을 방어해야 한다 | CRITICAL |
| NFR-1.2 | Path Traversal 공격을 방어해야 한다 | CRITICAL |
| NFR-1.3 | 토큰은 로그에 마스킹되어 출력되어야 한다 | HIGH |
| NFR-1.4 | 보안 검증은 설정으로 on/off 가능해야 한다 | MEDIUM |
| NFR-1.5 | 인증서 복사 공격 방지를 위해 IP 검증이 가능해야 한다 | MEDIUM |

### NFR-2: 테스트

| ID | 요구사항 |
|----|----------|
| NFR-2.1 | 단위 테스트 200개 이상을 작성해야 한다 |
| NFR-2.2 | 모든 테스트는 100% 통과해야 한다 |
| NFR-2.3 | 통합 테스트는 환경변수로 조건부 실행 가능해야 한다 |
| NFR-2.4 | 테스트 프레임워크는 JUnit 5를 사용해야 한다 |

### NFR-3: 아키텍처

| ID | 요구사항 |
|----|----------|
| NFR-3.1 | 의존성 주입(DI)을 통해 테스트 가능한 구조여야 한다 |
| NFR-3.2 | 주요 컴포넌트는 인터페이스로 추상화되어야 한다 |
| NFR-3.3 | 설정, HTTP 클라이언트는 Mock으로 대체 가능해야 한다 |
| NFR-3.4 | 버전은 단일 소스에서 관리되어야 한다 |

---

## 5. 제약 조건

### 5.1 기술 제약

| 제약 | 사유 |
|------|------|
| JDK 1.8 호환 | 레거시 환경 지원 |
| System.err 출력 금지 | 데몬 프로세스이므로 파일 로그만 사용 |

### 5.2 하위 호환성

- 기존 `PreWork`, `FirstWork`, `MainWork` 클래스명 유지
- 기존 `agent.properties` 설정 키 유지
- 기존 API 엔드포인트 계속 지원 (`/api/v1/security/refresh`)

---

## 6. 산출물 정의

### 6.1 소스코드

| 영역 | 설명 |
|------|------|
| 생명주기 관리 | 상태 관리, Graceful Shutdown |
| 서비스 레이어 | Kafka, 명령실행, 등록 서비스 |
| 보안 검증 | Command Injection, Path Traversal 방어 |
| DI 인프라 | 인터페이스, 어댑터, DI 컨테이너 |
| mTLS 지원 | 인증서 기반 HTTP 클라이언트 |

### 6.2 테스트 코드

| 유형 | 대상 |
|------|------|
| 단위 테스트 | 모든 신규 클래스 |
| 통합 테스트 | mTLS 인증 흐름, 토큰 갱신 흐름 |
| 보안 테스트 | 취약점 방어 검증 |

### 6.3 문서

| 문서 | 내용 |
|------|------|
| CLAUDE.md | AI를 위한 프로젝트 핵심 규칙 |
| ARCHITECTURE.md | 시스템 구조, 컴포넌트 다이어그램 |
| AUTHENTICATION_FLOW.md | mTLS + JWT 흐름 (Mermaid) |
| TEST_REPORT.md | 테스트 현황, 커버리지 |

---

## 7. 성공 기준

| 기준 | 측정 방법 |
|------|----------|
| 테스트 통과 | `./gradlew test` 실행 시 200개 이상 테스트 100% 통과 |
| 빌드 성공 | `./gradlew build` 실행 시 JAR 생성 |
| mTLS 동작 | Mock 서버와 mTLS 통신 성공 |
| Legacy 동작 | 기존 방식 인증 성공 |
| 보안 검증 | SecurityValidator 테스트 통과 |

---

## 8. Phase 정의

| Phase | 내용 | 예상 테스트 수 |
|-------|------|---------------|
| Phase 1 | 프로젝트 구조 및 Gradle 설정 | 10+ |
| Phase 2 | 생명주기 관리 프레임워크 | 30+ |
| Phase 3 | 서비스 레이어 분리 | 40+ |
| Phase 4 | 보안 검증 모듈 (Command Injection, Path Traversal) | 50+ |
| Phase 5 | DI 아키텍처 구현 | 30+ |
| Phase 6 | 테스트 서버 구현 (Auth, Biz, CA) | - |
| Phase 7 | mTLS 지원 및 OAuth2 토큰 관리 | 40+ |
| Phase 8 | 통합 테스트 (가상 서버 연동) | 30+ |
| Phase 9 | 문서화 및 최종 Push | - |

---

## 9. 의사결정 가이드 (이번 프로젝트 특화)

| 상황 | 결정 기준 |
|------|----------|
| 기존 코드 수정 vs 신규 작성 | 기존 로직 유지하며 래퍼/어댑터로 감싸기 우선 |
| 테스트 서버 기술 | Python Flask 사용 |
| 보안 검증 방식 | Whitelist 기반 (허용 목록만 통과) |

---

**문서 버전**: 1.0
**작성일**: 2025-12-22
